package com.iwhalecloud.ontology.service;

import lombok.extern.slf4j.Slf4j;
import org.semanticweb.owlapi.apibinding.OWLManager;
import org.semanticweb.owlapi.model.*;
import org.semanticweb.owlapi.reasoner.OWLReasoner;
import org.semanticweb.owlapi.reasoner.structural.StructuralReasonerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.Resource;
import org.springframework.stereotype.Service;

import jakarta.annotation.PostConstruct;
import java.util.*;
import java.util.stream.Collectors;

/**
 * OWL本体服务
 * 负责加载OWL本体、执行SWRL推理、查询类和个体
 *
 * @author 
 */
@Service
@Slf4j
public class OntologyService {

    @Value("${ontology.file.path}")
    private Resource ontologyResource;

    @Value("${ontology.namespace}")
    private String namespace;

    private OWLOntologyManager manager;
    private OWLOntology ontology;
    private OWLDataFactory dataFactory;
    private SWRLRuleEngine ruleEngine;
    private OWLReasoner reasoner;

    @PostConstruct
    public void init() throws Exception {
        log.info("初始化OWL本体服务...");
        
        // 创建OWL管理器和数据工厂
        manager = OWLManager.createOWLOntologyManager();
        dataFactory = manager.getOWLDataFactory();
        
        // 加载本体文件
        log.info("加载本体文件: {}", ontologyResource.getFilename());
        ontology = manager.loadOntologyFromOntologyDocument(ontologyResource.getInputStream());
        log.info("本体加载成功，包含 {} 个公理", ontology.getAxiomCount());
        
        // 创建SWRL规则引擎
        log.info("创建SWRL规则引擎...");
        ruleEngine = SWRLAPIFactory.createSWRLRuleEngine(ontology);
        
        // 创建推理器
        log.info("创建OWL推理器...");
        StructuralReasonerFactory reasonerFactory = new StructuralReasonerFactory();
        reasoner = reasonerFactory.createReasoner(ontology);
        
        log.info("OWL本体服务初始化完成");
        
        // 打印基本统计信息
        logOntologyStatistics();
    }

    /**
     * 打印本体统计信息
     */
    private void logOntologyStatistics() {
        int classCount = ontology.getClassesInSignature().size();
        int objectPropertyCount = ontology.getObjectPropertiesInSignature().size();
        int dataPropertyCount = ontology.getDataPropertiesInSignature().size();
        int individualCount = ontology.getIndividualsInSignature().size();
        
        log.info("=== 本体统计信息 ===");
        log.info("类数量: {}", classCount);
        log.info("对象属性数量: {}", objectPropertyCount);
        log.info("数据属性数量: {}", dataPropertyCount);
        log.info("个体数量: {}", individualCount);
        log.info("==================");
    }

    /**
     * 获取所有类
     */
    public List<Map<String, String>> getAllClasses() {
        return ontology.getClassesInSignature().stream()
                .filter(cls -> !cls.isOWLThing() && !cls.isOWLNothing())
                .map(this::classToMap)
                .collect(Collectors.toList());
    }

    /**
     * 获取所有个体
     */
    public List<Map<String, Object>> getAllIndividuals() {
        return ontology.getIndividualsInSignature().stream()
                .map(this::individualToMap)
                .collect(Collectors.toList());
    }

    /**
     * 根据类名获取个体
     */
    public List<Map<String, Object>> getIndividualsByClass(String className) {
        OWLClass owlClass = dataFactory.getOWLClass(IRI.create(namespace + className));
        
        return reasoner.getInstances(owlClass, false)
                .entities()
                .map(this::individualToMap)
                .collect(Collectors.toList());
    }

    /**
     * 添加新的个体
     */
    public Map<String, String> addIndividual(String className, String individualName) {
        OWLClass owlClass = dataFactory.getOWLClass(IRI.create(namespace + className));
        OWLNamedIndividual individual = dataFactory.getOWLNamedIndividual(IRI.create(namespace + individualName));
        
        // 创建类断言公理
        OWLClassAssertionAxiom axiom = dataFactory.getOWLClassAssertionAxiom(owlClass, individual);
        manager.addAxiom(ontology, axiom);
        
        log.info("添加个体: {} 到类: {}", individualName, className);
        
        Map<String, String> result = new HashMap<>();
        result.put("individual", individualName);
        result.put("class", className);
        result.put("iri", individual.getIRI().toString());
        return result;
    }

    /**
     * 为个体添加数据属性
     */
    public void addDataProperty(String individualName, String propertyName, String value, String datatype) {
        OWLNamedIndividual individual = dataFactory.getOWLNamedIndividual(IRI.create(namespace + individualName));
        OWLDataProperty property = dataFactory.getOWLDataProperty(IRI.create(namespace + propertyName));
        
        OWLLiteral literal;
        switch (datatype.toLowerCase()) {
            case "integer":
                literal = dataFactory.getOWLLiteral(value, dataFactory.getIntegerOWLDatatype());
                break;
            case "boolean":
                literal = dataFactory.getOWLLiteral(Boolean.parseBoolean(value));
                break;
            case "decimal":
                literal = dataFactory.getOWLLiteral(value, dataFactory.getOWLDatatype(IRI.create("http://www.w3.org/2001/XMLSchema#decimal")));
                break;
            default:
                literal = dataFactory.getOWLLiteral(value);
        }
        
        OWLDataPropertyAssertionAxiom axiom = dataFactory.getOWLDataPropertyAssertionAxiom(property, individual, literal);
        manager.addAxiom(ontology, axiom);
        
        log.info("为个体 {} 添加数据属性: {}={}", individualName, propertyName, value);
    }

    /**
     * 为个体添加对象属性
     */
    public void addObjectProperty(String sourceIndividual, String propertyName, String targetIndividual) {
        OWLNamedIndividual source = dataFactory.getOWLNamedIndividual(IRI.create(namespace + sourceIndividual));
        OWLNamedIndividual target = dataFactory.getOWLNamedIndividual(IRI.create(namespace + targetIndividual));
        OWLObjectProperty property = dataFactory.getOWLObjectProperty(IRI.create(namespace + propertyName));
        
        OWLObjectPropertyAssertionAxiom axiom = dataFactory.getOWLObjectPropertyAssertionAxiom(property, source, target);
        manager.addAxiom(ontology, axiom);
        
        log.info("为个体 {} 添加对象属性: {} -> {}", sourceIndividual, propertyName, targetIndividual);
    }

    /**
     * 执行SWRL推理
     */
    public Map<String, Object> executeSWRLReasoning() {
        try {
            log.info("执行SWRL规则推理...");
            ruleEngine.infer();
            
            Map<String, Object> result = new HashMap<>();
            result.put("status", "success");
            result.put("message", "SWRL推理执行成功");
            result.put("ruleCount", ruleEngine.getSWRLRules().size());
            
            log.info("SWRL推理完成，规则数量: {}", ruleEngine.getSWRLRules().size());
            return result;
        } catch (Exception e) {
            log.error("SWRL推理执行失败", e);
            Map<String, Object> result = new HashMap<>();
            result.put("status", "error");
            result.put("message", e.getMessage());
            return result;
        }
    }

    /**
     * 查询个体的属性
     */
    public Map<String, Object> getIndividualProperties(String individualName) {
        OWLNamedIndividual individual = dataFactory.getOWLNamedIndividual(IRI.create(namespace + individualName));
        
        Map<String, Object> properties = new HashMap<>();
        properties.put("individual", individualName);
        properties.put("iri", individual.getIRI().toString());
        
        // 获取数据属性
        Map<String, Object> dataProperties = new HashMap<>();
        ontology.getDataPropertyAssertionAxioms(individual).forEach(axiom -> {
            String propName = axiom.getProperty().asOWLDataProperty().getIRI().getShortForm();
            String value = axiom.getObject().getLiteral();
            dataProperties.put(propName, value);
        });
        properties.put("dataProperties", dataProperties);
        
        // 获取对象属性
        Map<String, String> objectProperties = new HashMap<>();
        ontology.getObjectPropertyAssertionAxioms(individual).forEach(axiom -> {
            String propName = axiom.getProperty().asOWLObjectProperty().getIRI().getShortForm();
            String targetName = axiom.getObject().asOWLNamedIndividual().getIRI().getShortForm();
            objectProperties.put(propName, targetName);
        });
        properties.put("objectProperties", objectProperties);
        
        return properties;
    }

    /**
     * 将OWL类转换为Map
     */
    private Map<String, String> classToMap(OWLClass owlClass) {
        Map<String, String> map = new HashMap<>();
        map.put("name", owlClass.getIRI().getShortForm());
        map.put("iri", owlClass.getIRI().toString());
        
        // 获取标签
        ontology.getAnnotationAssertionAxioms(owlClass.getIRI()).stream()
                .filter(ax -> ax.getProperty().isLabel())
                .findFirst()
                .ifPresent(ax -> {
                    if (ax.getValue() instanceof OWLLiteral) {
                        map.put("label", ((OWLLiteral) ax.getValue()).getLiteral());
                    }
                });
        
        return map;
    }

    /**
     * 将OWL个体转换为Map
     */
    private Map<String, Object> individualToMap(OWLNamedIndividual individual) {
        Map<String, Object> map = new HashMap<>();
        map.put("name", individual.getIRI().getShortForm());
        map.put("iri", individual.getIRI().toString());
        
        // 获取类型
        Set<String> types = reasoner.getTypes(individual, true)
                .entities()
                .map(cls -> cls.getIRI().getShortForm())
                .collect(Collectors.toSet());
        map.put("types", types);
        
        return map;
    }

    /**
     * 获取本体信息
     */
    public Map<String, Object> getOntologyInfo() {
        Map<String, Object> info = new HashMap<>();
        info.put("iri", ontology.getOntologyID().getOntologyIRI().map(IRI::toString).orElse("N/A"));
        info.put("classCount", ontology.getClassesInSignature().size());
        info.put("objectPropertyCount", ontology.getObjectPropertiesInSignature().size());
        info.put("dataPropertyCount", ontology.getDataPropertiesInSignature().size());
        info.put("individualCount", ontology.getIndividualsInSignature().size());
        info.put("axiomCount", ontology.getAxiomCount());
        info.put("namespace", namespace);
        return info;
    }
}
